# å›¾åºŠä¸Šä¼ ä¸ OCR è¯†åˆ«åŠŸèƒ½ä½¿ç”¨æŒ‡å—

## åŠŸèƒ½æ¦‚è¿°

æ–°å¢äº†å›¾åºŠä¸Šä¼ åŠŸèƒ½ï¼Œå¹¶ä¼˜åŒ–äº† OCR è¯†åˆ«çš„äº¤äº’æµç¨‹ï¼š
1. ç”¨æˆ·å…ˆä¸Šä¼ å›¾ç‰‡åˆ°æœåŠ¡å™¨
2. ä¸Šä¼ æˆåŠŸåè·å¾—æ–‡ä»¶è·¯å¾„
3. ç‚¹å‡»"æ–‡å­—è¯†åˆ«"æŒ‰é’®è¿›è¡Œ OCR è¯†åˆ«

## API æ¥å£

### 1. å›¾ç‰‡ä¸Šä¼ 

**ç«¯ç‚¹**: `POST /api/image/upload`

**è¯·æ±‚**: multipart/form-data
```bash
curl -X POST http://localhost:3000/api/image/upload \
  -F "file=@/path/to/image.png"
```

**å“åº”**:
```json
{
  "success": true,
  "path": "1735123456789_a1b2c3d4.png"
}
```

æˆ–é”™è¯¯å“åº”ï¼š
```json
{
  "success": false,
  "error": "é”™è¯¯ä¿¡æ¯"
}
```

**æ–‡ä»¶åç”Ÿæˆè§„åˆ™**:
- æ ¼å¼: `{timestamp}_{random}.{extension}`
- timestamp: æ¯«ç§’çº§æ—¶é—´æˆ³
- random: 8ä½åå…­è¿›åˆ¶éšæœºæ•°
- extension: ä»åŸæ–‡ä»¶åæˆ– content-type æ¨æ–­

**æ”¯æŒçš„å›¾ç‰‡æ ¼å¼**:
- PNG (.png)
- JPEG/JPG (.jpg, .jpeg)
- GIF (.gif)
- WebP (.webp)
- BMP (.bmp)

### 2. OCR è¯†åˆ«ï¼ˆæ”¯æŒç›¸å¯¹è·¯å¾„ï¼‰

**ç«¯ç‚¹**: `POST /api/ocr/single_pic`

**è¯·æ±‚**: application/json
```bash
# ä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼ˆä» storage_dir è§£æï¼‰
curl -X POST http://localhost:3000/api/ocr/single_pic \
  -H "Content-Type: application/json" \
  -d '{
    "image_path": "1735123456789_a1b2c3d4.png",
    "include_position": false
  }'

# ä½¿ç”¨ç»å¯¹è·¯å¾„ï¼ˆä»ç„¶æ”¯æŒï¼‰
curl -X POST http://localhost:3000/api/ocr/single_pic \
  -H "Content-Type: application/json" \
  -d '{
    "image_path": "/absolute/path/to/image.png",
    "include_position": true
  }'
```

**è·¯å¾„è§£æè§„åˆ™**:
- å¦‚æœä»¥ `/` å¼€å¤´æˆ–åŒ…å« `:` (Windows è·¯å¾„) â†’ ç»å¯¹è·¯å¾„
- å¦åˆ™ â†’ ç›¸å¯¹è·¯å¾„ï¼Œæ‹¼æ¥ä¸º `{storage_dir}/{image_path}`

## é…ç½®

åœ¨é…ç½®æ–‡ä»¶ä¸­æ·»åŠ å›¾åºŠé…ç½®ï¼ˆå¦‚ `manifest/dev/remote_ocr.toml`ï¼‰ï¼š

```toml
[image_hosting]
storage_dir = "uploads"
# æ¸…ç†ä»»åŠ¡æ£€æŸ¥é—´éš”ï¼Œå•ä½ç§’ï¼Œé»˜è®¤ 3600ï¼ˆ1å°æ—¶ï¼‰
cleanup_interval_secs = 3600
# æ–‡ä»¶è¿‡æœŸæ—¶é—´ï¼Œå•ä½ç§’ï¼Œé»˜è®¤ 3600ï¼ˆ1å°æ—¶ï¼‰
file_expire_secs = 3600
```

**é…ç½®è¯´æ˜**:
- `storage_dir`: å­˜å‚¨ä¸Šä¼ å›¾ç‰‡çš„ç›®å½•ï¼ˆç›¸å¯¹æˆ–ç»å¯¹è·¯å¾„ï¼‰
- `cleanup_interval_secs`: å®šæ—¶æ¸…ç†ä»»åŠ¡çš„æ£€æŸ¥é—´éš”ï¼ˆé»˜è®¤ 3600 ç§’ = 1 å°æ—¶ï¼‰
- `file_expire_secs`: æ–‡ä»¶è¿‡æœŸæ—¶é—´ï¼Œè¶…è¿‡æ­¤æ—¶é—´çš„æ–‡ä»¶å°†è¢«åˆ é™¤ï¼ˆé»˜è®¤ 3600 ç§’ = 1 å°æ—¶ï¼‰

**è‡ªåŠ¨æ¸…ç†æœºåˆ¶**:
- æœåŠ¡å™¨å¯åŠ¨æ—¶è‡ªåŠ¨å¼€å¯å®šæ—¶æ¸…ç†ä»»åŠ¡
- æ¯éš” `cleanup_interval_secs` ç§’æ£€æŸ¥ä¸€æ¬¡å­˜å‚¨ç›®å½•
- åˆ é™¤åˆ›å»ºæ—¶é—´è¶…è¿‡ `file_expire_secs` çš„æ–‡ä»¶
- æ¸…ç†æ—¥å¿—ä¼šæ˜¾ç¤ºåˆ é™¤çš„æ–‡ä»¶æ•°é‡å’Œé‡Šæ”¾çš„ç©ºé—´

**æ³¨æ„**:
- `storage_dir` æ˜¯å­˜å‚¨ä¸Šä¼ å›¾ç‰‡çš„ç›®å½•
- å¦‚æœç›®å½•ä¸å­˜åœ¨ï¼Œä¼šè‡ªåŠ¨åˆ›å»º
- å»ºè®®å°† `uploads/` æ·»åŠ åˆ° `.gitignore`

## å‰ç«¯ä½¿ç”¨

### æ–°çš„ OCR è¯†åˆ«æµç¨‹

1. **é€‰æ‹©å›¾ç‰‡**: ç”¨æˆ·é€šè¿‡æ–‡ä»¶é€‰æ‹©å™¨é€‰æ‹©å›¾ç‰‡
2. **ä¸Šä¼ å›¾ç‰‡**: è‡ªåŠ¨ä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼Œæ˜¾ç¤ºä¸Šä¼ è¿›åº¦
3. **æ˜¾ç¤ºè·¯å¾„**: ä¸Šä¼ æˆåŠŸåæ˜¾ç¤ºæ–‡ä»¶è·¯å¾„
4. **æ–‡å­—è¯†åˆ«**: ç‚¹å‡»"æ–‡å­—è¯†åˆ«"æŒ‰é’®ï¼Œè°ƒç”¨ OCR API
5. **æŸ¥çœ‹ç»“æœ**: æ˜¾ç¤ºè¯†åˆ«çš„æ–‡å­—å†…å®¹

### ç•Œé¢ç¤ºä¾‹

è®¿é—® http://localhost:3000 â†’ OCR é¡µé¢ â†’ æ–‡å­—è¯†åˆ«æ ‡ç­¾ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å›¾ç‰‡ä¸Šä¼ ä¸è¯†åˆ«                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ é€‰æ‹©å›¾ç‰‡: [é€‰æ‹©æ–‡ä»¶]                â”‚
â”‚ ä¸Šä¼ ä¸­...                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å·²ä¸Šä¼ å›¾ç‰‡è·¯å¾„:                     â”‚
â”‚ 1735123456789_a1b2c3d4.png         â”‚
â”‚                                     â”‚
â”‚ â˜‘ åŒ…å«åæ ‡ä¿¡æ¯                      â”‚
â”‚                                     â”‚
â”‚ [ğŸ“ æ–‡å­—è¯†åˆ«]                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç»“æœ:                               â”‚
â”‚ è¯†åˆ«åˆ°çš„æ–‡å­—å†…å®¹...                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æµ‹è¯•æ­¥éª¤

### 1. å¯åŠ¨æœåŠ¡

```bash
cd /opt/mystorage/github/rsde
API_CONFIG=manifest/dev/remote_ocr.toml cargo run -p apiserver

# å¯åŠ¨æ—¥å¿—ä¼šæ˜¾ç¤ºï¼š
# INFO apiserver::image: å¯åŠ¨æ–‡ä»¶æ¸…ç†ä»»åŠ¡: é—´éš”=3600ç§’, è¿‡æœŸæ—¶é—´=3600ç§’
```

### 2. æµ‹è¯•è‡ªåŠ¨æ¸…ç†ï¼ˆå¯é€‰ï¼‰

ä½¿ç”¨æä¾›çš„æµ‹è¯•è„šæœ¬ï¼š

```bash
./test_cleanup.sh
```

è¯¥è„šæœ¬ä¼šï¼š
1. åˆ›å»ºæµ‹è¯•ç›®å½•å’Œæ–‡ä»¶
2. ä½¿ç”¨çŸ­æ—¶é—´é…ç½®ï¼ˆ5ç§’æ£€æŸ¥ï¼Œ1ç§’è¿‡æœŸï¼‰
3. è§‚å¯Ÿæ¸…ç†ä»»åŠ¡çš„è¿è¡Œ

é¢„æœŸè¾“å‡ºï¼š
```
INFO apiserver::image: å¼€å§‹æ¸…ç†è¿‡æœŸæ–‡ä»¶: storage_dir=uploads_test, expire_secs=1
INFO apiserver::image: åˆ é™¤è¿‡æœŸæ–‡ä»¶: Some("old_file.txt"), å¹´é¾„: 2h 30m
INFO apiserver::image: æ¸…ç†å®Œæˆ: æ‰«æ 2 ä¸ªæ–‡ä»¶, åˆ é™¤ 1 ä¸ªè¿‡æœŸæ–‡ä»¶, é‡Šæ”¾ 14 å­—èŠ‚
```

### 3. æµ‹è¯•ä¸Šä¼ 

```bash
# å‡†å¤‡ä¸€å¼ æµ‹è¯•å›¾ç‰‡
curl -X POST http://localhost:3000/api/image/upload \
  -F "file=@manifest/dev/tm_1.png"

# å“åº”ç¤ºä¾‹
# {"success":true,"path":"1735123456789_a1b2c3d4.png"}
```

### 3. æµ‹è¯•è¯†åˆ«

```bash
# ä½¿ç”¨ä¸Šä¼ è¿”å›çš„è·¯å¾„
curl -X POST http://localhost:3000/api/ocr/single_pic \
  -H "Content-Type: application/json" \
  -d '{
    "image_path": "1735123456789_a1b2c3d4.png",
    "include_position": false
  }'
```

### 4. éªŒè¯æ–‡ä»¶

```bash
# æ£€æŸ¥ä¸Šä¼ çš„æ–‡ä»¶
ls -lh uploads/
```

## å®‰å…¨æ€§è€ƒè™‘

1. **æ–‡ä»¶å¤§å°é™åˆ¶**: é»˜è®¤æ— é™åˆ¶ï¼Œå»ºè®®åœ¨ axum ä¸­é…ç½® `DefaultBodyLimit`
2. **æ–‡ä»¶ç±»å‹éªŒè¯**: ä»…æ£€æŸ¥æ‰©å±•åå’Œ content-typeï¼Œæœªè¿›è¡Œæ·±åº¦éªŒè¯
3. **è·¯å¾„éå†é˜²æŠ¤**: ç›¸å¯¹è·¯å¾„ä¼šæ‹¼æ¥åˆ° storage_dirï¼Œé¿å…ä½¿ç”¨ `../`
4. **å­˜å‚¨ç©ºé—´**: å·²å†…ç½®å®šæ—¶æ¸…ç†æœºåˆ¶ï¼Œè‡ªåŠ¨åˆ é™¤è¿‡æœŸæ–‡ä»¶
5. **æ¸…ç†å®‰å…¨**: åªåˆ é™¤æ–‡ä»¶ï¼Œä¸åˆ é™¤ç›®å½•ï¼Œé¿å…è¯¯åˆ 

## å®šæ—¶æ¸…ç†æœºåˆ¶

### å·¥ä½œåŸç†

1. **å¯åŠ¨æ—¶åˆå§‹åŒ–**: æœåŠ¡å™¨å¯åŠ¨æ—¶è‡ªåŠ¨å¼€å¯æ¸…ç†ä»»åŠ¡
2. **å®šæ—¶æ£€æŸ¥**: æ¯éš” `cleanup_interval_secs` æ‰§è¡Œä¸€æ¬¡æ¸…ç†
3. **æ–‡ä»¶å¹´é¾„åˆ¤æ–­**: åŸºäºæ–‡ä»¶çš„åˆ›å»ºæ—¶é—´ï¼ˆ`created`ï¼‰
4. **å®‰å…¨åˆ é™¤**: åªåˆ é™¤æ™®é€šæ–‡ä»¶ï¼Œè·³è¿‡ç›®å½•å’Œå…¶ä»–ç±»å‹

### é…ç½®è°ƒä¼˜

**çŸ­å‘¨æœŸæ¸…ç†**ï¼ˆé€‚åˆæµ‹è¯•/ä¸´æ—¶æ–‡ä»¶ï¼‰:
```toml
[image_hosting]
storage_dir = "uploads"
cleanup_interval_secs = 300   # 5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
file_expire_secs = 600         # 10åˆ†é’Ÿè¿‡æœŸ
```

**é•¿æœŸå­˜å‚¨**ï¼ˆé€‚åˆç”Ÿäº§ç¯å¢ƒï¼‰:
```toml
[image_hosting]
storage_dir = "uploads"
cleanup_interval_secs = 86400  # 24å°æ—¶æ£€æŸ¥ä¸€æ¬¡
file_expire_secs = 604800      # 7å¤©è¿‡æœŸ
```

**ç¦ç”¨æ¸…ç†**ï¼ˆä¸æ¨èï¼‰:
```toml
[image_hosting]
storage_dir = "uploads"
cleanup_interval_secs = 0      # è®¾ä¸º0ä¼šä½¿ç”¨é»˜è®¤å€¼3600
file_expire_secs = 999999999   # è®¾ç½®ä¸€ä¸ªè¶…å¤§å€¼
```

### ç›‘æ§æ¸…ç†ä»»åŠ¡

æŸ¥çœ‹æ—¥å¿—è¾“å‡ºï¼š

```bash
# æ¸…ç†å¼€å§‹
INFO apiserver::image: å¼€å§‹æ¸…ç†è¿‡æœŸæ–‡ä»¶: storage_dir=uploads, expire_secs=3600

# åˆ é™¤æ–‡ä»¶
INFO apiserver::image: åˆ é™¤è¿‡æœŸæ–‡ä»¶: "1735123456789_a1b2c3d4.png", å¹´é¾„: 1h 5m

# æ¸…ç†å®Œæˆ
INFO apiserver::image: æ¸…ç†å®Œæˆ: æ‰«æ 10 ä¸ªæ–‡ä»¶, åˆ é™¤ 3 ä¸ªè¿‡æœŸæ–‡ä»¶, é‡Šæ”¾ 1024000 å­—èŠ‚
```

## å»ºè®®æ”¹è¿›

### ç”Ÿäº§ç¯å¢ƒ

1. **æ·»åŠ æ–‡ä»¶å¤§å°é™åˆ¶**:
   ```rust
   use axum::extract::DefaultBodyLimit;
   
   app.layer(DefaultBodyLimit::max(10 * 1024 * 1024)) // 10MB
   ```

2. **æ·»åŠ æ–‡ä»¶ç±»å‹éªŒè¯** (ä½¿ç”¨ `infer` crate):
   ```rust
   let kind = infer::get(&data)?;
   if !kind.mime_type().starts_with("image/") {
       return Err("ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹");
   }
   ```

3. **æ·»åŠ é™æ€æ–‡ä»¶æœåŠ¡** (è®¿é—®ä¸Šä¼ çš„å›¾ç‰‡):
   ```rust
   .nest_service("/uploads", ServeDir::new("uploads"))
   ```

4. **æ·»åŠ è®¤è¯**: é˜²æ­¢æœªæˆæƒä¸Šä¼ 
5. **æ·»åŠ é™æµ**: é˜²æ­¢æ»¥ç”¨
6. **è°ƒæ•´æ¸…ç†ç­–ç•¥**: æ ¹æ®ä¸šåŠ¡éœ€æ±‚è°ƒæ•´æ¸…ç†é—´éš”å’Œè¿‡æœŸæ—¶é—´
7. **ç›‘æ§å­˜å‚¨ç©ºé—´**: è®¾ç½®ç£ç›˜ç©ºé—´å‘Šè­¦
## æ•…éšœæ’æŸ¥

### ä¸Šä¼ å¤±è´¥

- **æ£€æŸ¥é…ç½®**: ç¡®ä¿ `[image_hosting]` é…ç½®å­˜åœ¨
- **æ£€æŸ¥æƒé™**: uploads ç›®å½•éœ€è¦å†™æƒé™
- **æ£€æŸ¥å¤§å°**: æ–‡ä»¶æ˜¯å¦è¶…è¿‡é»˜è®¤é™åˆ¶

### è¯†åˆ«å¤±è´¥

- **æ£€æŸ¥è·¯å¾„**: ç¡®è®¤æ–‡ä»¶ç¡®å®å­˜åœ¨äº storage_dir
- **æ£€æŸ¥æ ¼å¼**: è¿œç¨‹ OCR æœåŠ¡æ˜¯å¦æ”¯æŒè¯¥æ ¼å¼
- **æŸ¥çœ‹æ—¥å¿—**: æ£€æŸ¥ apiserver æ—¥å¿—è¾“å‡º

### å‰ç«¯é—®é¢˜

- **é‡æ–°æ„å»º**: `cd webserver/frontend && npm run build`
- **æ¸…é™¤ç¼“å­˜**: æµè§ˆå™¨ç¡¬åˆ·æ–° Ctrl+Shift+R
- **æ£€æŸ¥ç½‘ç»œ**: æµè§ˆå™¨å¼€å‘è€…å·¥å…· Network æ ‡ç­¾
