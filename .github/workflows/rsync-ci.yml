name: Rsync CI/CD

on:
  push:
    branches: [ master, main, develop ]
    paths:
      - 'rsync/**'
      - '.github/workflows/rsync-ci.yml'
      - 'apiserver/**'
      - 'common/**'
      - 'pic_recog/**'
      - 'webserver/**'
      - 'test/**'
      - 'Dockerfile'
  pull_request:
    branches: [ master, main, develop ]
    paths:
      - 'rsync/**'
      - '.github/workflows/rsync-ci.yml'
      - 'apiserver/**'
      - 'common/**'
      - 'pic_recog/**'
      - 'webserver/**'
      - 'test/**'

env:
  CARGO_TERM_COLOR: always
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/xy

jobs:
  test:
    name: Run Unit Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        components: rustfmt, clippy
    
    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: ~/.cargo/registry
        key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-registry-
    
    - name: Cache cargo index
      uses: actions/cache@v4
      with:
        path: ~/.cargo/git
        key: ${{ runner.os }}-cargo-git-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-git-
    
    - name: Cache target directory
      uses: actions/cache@v4
      with:
        path: rsync/target
        key: ${{ runner.os }}-cargo-target-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-target-
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: webserver/frontend/package-lock.json
    
    - name: Build frontend
      run: |
        echo "Building frontend for apiserver..."
        cd webserver
        make build
        ls -lh frontend/dist/
    
    - name: Check formatting
      working-directory: ./rsync
      run: make fmt-check
    
    - name: Run clippy
      working-directory: ./rsync
      run: make clippy
    
    - name: Run tests
      working-directory: ./rsync
      run: make test
    
    - name: Build release binary
      working-directory: ./rsync
      run: make build

  helm-lint:
    name: Helm Chart Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Helm
      uses: azure/setup-helm@v4
      with:
        version: 'latest'
    
    - name: Helm lint
      run: helm lint helm/rsde --values helm/rsde/values-example.yaml
    
    - name: Helm template dry-run
      run: |
        helm template rsde-apiserver ./helm/rsde \
          --values helm/rsde/values-example.yaml \
          --set image.repository=xy \
          --set image.tag=test \
          --debug

  docker-build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: [test, helm-lint]
    if: github.event_name == 'push'
    
    permissions:
      contents: read
      packages: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: webserver/frontend/package-lock.json
    
    - name: Build frontend
      run: |
        echo "Building frontend for Docker image..."
        cd webserver
        make build
        ls -lh frontend/dist/
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=sha,prefix={{branch}}-
          type=raw,value=latest,enable={{is_default_branch}}
    
    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

  helm-test:
    name: Helm Chart Deployment Test
    runs-on: ubuntu-latest
    needs: [docker-build]
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Helm
      uses: azure/setup-helm@v4
      with:
        version: 'latest'
    
    - name: Set up Kind (Kubernetes in Docker)
      uses: helm/kind-action@v1
      with:
        cluster_name: rsde-test
        wait: 120s
    
    - name: Verify cluster
      run: |
        kubectl cluster-info
        kubectl get nodes
    
    - name: Build Docker image for Kind
      run: |
        docker build -t xy:test -f Dockerfile .
    
    - name: Load image into Kind
      run: |
        kind load docker-image xy:test --name rsde-test
    
    - name: Create namespace
      run: |
        kubectl create namespace xy
    
    - name: Deploy Redis for testing
      run: |
        helm repo add bitnami https://charts.bitnami.com/bitnami
        helm install test-redis bitnami/redis \
          --namespace xy \
          --set auth.password=testpass_2024 \
          --set master.persistence.enabled=false \
          --set replica.replicaCount=0 \
          --wait --timeout 3m
    
    - name: Deploy with Helm
      run: |
        helm install rsde-apiserver ./helm/rsde \
          --namespace xy \
          --values helm/rsde/values-example.yaml \
          --set image.repository=xy \
          --set image.tag=test \
          --set image.pullPolicy=IfNotPresent \
          --set config.anybox.redis_url="redis://:testpass_2024@test-redis-master.xy.svc.cluster.local/" \
          --wait --timeout 5m
    
    - name: Check deployment status
      run: |
        kubectl get all -n xy
        kubectl get pods -n xy -o wide
    
    - name: Wait for pod to be ready
      run: |
        kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=rsde-apiserver -n xy --timeout=300s
    
    - name: Check pod logs
      run: |
        kubectl logs -l app.kubernetes.io/name=rsde-apiserver -n xy --tail=50
    
    - name: Test application
      run: |
        POD_NAME=$(kubectl get pods -l app.kubernetes.io/name=rsde-apiserver -n xy -o jsonpath='{.items[0].metadata.name}')
        echo "Testing pod: $POD_NAME"
        
        # Check if the application is running
        kubectl exec -n xy $POD_NAME -- ps aux | grep apiserver || true
        
        # Test health endpoint
        kubectl exec -n xy $POD_NAME -- wget -q -O- http://localhost:3000/api/anybox/health || echo "Health check failed"
        
        # Check logs
        kubectl logs -n xy $POD_NAME --tail=20
    
    - name: Helm test (if test hooks exist)
      run: |
        helm test rsde-apiserver -n xy || echo "No helm tests defined"
    
    - name: Cleanup
      if: always()
      run: |
        helm uninstall rsde-apiserver -n xy || true
        kubectl delete namespace xy || true

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [helm-test]
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Package Helm chart
      run: |
        helm package helm/rsde -d .
    
    - name: Upload Helm chart artifact
      uses: actions/upload-artifact@v4
      with:
        name: helm-chart
        path: rsde-*.tgz
        retention-days: 30
