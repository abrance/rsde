name: Release

on:
  push:
    tags:
      - 'v*.*.*'  # 匹配 v1.0.0, v2.1.3 等格式的 tag

permissions:
  contents: write  # 需要写权限来创建 release

env:
  CARGO_TERM_COLOR: always

jobs:
  build-release:
    name: Build Release Binaries
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            make_target: release-linux-x86_64
            asset_name: rsde-linux-x86_64
          # - os: ubuntu-latest
          #   target: aarch64-unknown-linux-gnu
          #   make_target: release-linux-aarch64
          #   asset_name: rsde-linux-aarch64
          # - os: macos-latest
          #   target: x86_64-apple-darwin
          #   make_target: release-darwin-x86_64
          #   asset_name: rsde-darwin-x86_64
          # - os: macos-latest
          #   target: aarch64-apple-darwin
          #   make_target: release-darwin-aarch64
          #   asset_name: rsde-darwin-aarch64
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: ${{ matrix.target }}
    
    # - name: Install cross-compilation tools (Linux ARM64)
    #   if: matrix.target == 'aarch64-unknown-linux-gnu'
    #   run: |
    #     sudo apt-get update
    #     sudo apt-get install -y gcc-aarch64-linux-gnu
    
    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: ~/.cargo/registry
        key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Cache cargo index
      uses: actions/cache@v4
      with:
        path: ~/.cargo/git
        key: ${{ runner.os }}-cargo-git-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Cache target directory
      uses: actions/cache@v4
      with:
        path: target
        key: ${{ runner.os }}-${{ matrix.target }}-cargo-target-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: webserver/frontend/package-lock.json
    
    - name: Build frontend
      run: |
        echo "Building frontend..."
        cd webserver
        make build
        echo "Frontend build completed"
        ls -lh frontend/dist/
    
    - name: Build release binaries with Make
      run: |
        echo "Building for target: ${{ matrix.target }}"
        make ${{ matrix.make_target }}
        echo "Build completed successfully"
        ls -lh bin/
    
    - name: Create release directory structure
      run: |
        mkdir -p rsde
        cp bin/*-${{ matrix.target }} rsde/ 2>/dev/null || cp bin/*-linux-x86_64 rsde/
        cp rsync/README.md rsde/ 2>/dev/null || echo "# RSDE" > rsde/README.md
        cp rsync/example.toml rsde/ 2>/dev/null || true

        # 创建版本信息文件
        cat > rsde/VERSION << EOF
        Version: ${{ github.ref_name }}
        Git Commit: ${{ github.sha }}
        Build Date: $(date -u +"%Y-%m-%dT%H:%M:%SZ")
        Target: ${{ matrix.target }}
        Components: rsync, rc, webserver, apiserver
        EOF
    
    - name: Create tarball
      run: |
        tar czf ${{ matrix.asset_name }}.tar.gz rsde/
        sha256sum ${{ matrix.asset_name }}.tar.gz > ${{ matrix.asset_name }}.tar.gz.sha256
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.asset_name }}
        path: |
          ${{ matrix.asset_name }}.tar.gz
          ${{ matrix.asset_name }}.tar.gz.sha256
        retention-days: 5

  create-release:
    name: Create GitHub Release
    needs: build-release
    runs-on: ubuntu-latest
    permissions:
      contents: write  # 需要写权限来创建和更新 release
      packages: write  # 需要推送 Helm chart 到 GHCR
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # 获取完整历史以生成 changelog
    
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
    
    - name: Prepare release assets
      run: |
        mkdir -p release-assets
        find artifacts -name "*.tar.gz*" -exec cp {} release-assets/ \;
        ls -lh release-assets/
    
    - name: Set up Helm
      uses: azure/setup-helm@v4
      with:
        version: 'latest'
    
    - name: Package Helm chart
      run: |
        VERSION=${{ github.ref_name }}
        VERSION=${VERSION#v}  # 移除 v 前缀
        sed -i "s/^version:.*/version: ${VERSION}/" rsync/helm/rsync/Chart.yaml
        sed -i "s/^appVersion:.*/appVersion: \"${VERSION}\"/" rsync/helm/rsync/Chart.yaml
        helm package rsync/helm/rsync -d release-assets/
    
    - name: Generate changelog
      id: changelog
      run: |
        # 获取上一个 tag
        PREVIOUS_TAG=$(git describe --abbrev=0 --tags $(git rev-list --tags --skip=1 --max-count=1) 2>/dev/null || echo "")
        
        if [ -z "$PREVIOUS_TAG" ]; then
          # 如果没有上一个 tag，获取所有提交
          CHANGELOG=$(git log --pretty=format:"- %s (%h)" --no-merges)
        else
          # 获取两个 tag 之间的提交
          CHANGELOG=$(git log ${PREVIOUS_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
        fi
        
        # 保存到文件
        cat > CHANGELOG.md << 'EOF'
        ## What's Changed
        
        ${CHANGELOG}
        
        ## Installation
        
        Download the appropriate tarball for your platform:
        
        - **Linux x86_64**: `rsde-linux-x86_64.tar.gz`
        # - **Linux ARM64**: `rsde-linux-aarch64.tar.gz`
        # - **macOS x86_64**: `rsde-darwin-x86_64.tar.gz`
        # - **macOS ARM64** (Apple Silicon): `rsde-darwin-aarch64.tar.gz`
        
        Extract and run:
        ```bash
        tar xzf rsde-*.tar.gz
        cd rsde
        ./rsync-linux-x86_64 --help
        ./rc-linux-x86_64 --help
        ./webserver-linux-x86_64 --help
        ./apiserver-linux-x86_64 --help
        ```
        
        ## Verification
        
        Each release includes SHA256 checksums. Verify your download:
        ```bash
        sha256sum -c rsde-*.tar.gz.sha256
        ```
        
        ## Docker Image
        
        Docker image is available at:
        ```
        docker pull ghcr.io/${{ github.repository }}/xy:${{ github.ref_name }}
        ```
        
        ## Helm Chart
        
        Deploy to Kubernetes:
        ```bash
        helm install rsync oci://ghcr.io/${{ github.repository }}/helm/rsync --version ${{ github.ref_name }}
        ```
        EOF
        
        echo "CHANGELOG.md created"
    
    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        files: release-assets/*
        body_path: CHANGELOG.md
        draft: false
        prerelease: ${{ contains(github.ref_name, 'alpha') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'rc') }}
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Push Helm chart to GHCR
      run: |
        VERSION=${{ github.ref_name }}
        VERSION=${VERSION#v}
        echo ${{ secrets.GITHUB_TOKEN }} | helm registry login ghcr.io -u ${{ github.actor }} --password-stdin
        helm push release-assets/rsync-${VERSION}.tgz oci://ghcr.io/${{ github.repository }}/helm

  build-docker:
    name: Build and Push Docker Image for Release
    needs: create-release
    runs-on: ubuntu-latest
    permissions:
      contents: write  # 需要写权限
      packages: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ghcr.io/${{ github.repository }}/xy
        tags: |
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=semver,pattern={{major}}
          type=sha
    
    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        platforms: linux/amd64  # ,linux/arm64
